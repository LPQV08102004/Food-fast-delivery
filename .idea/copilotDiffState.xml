<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/FIX_CORS_ERROR_GUIDE.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/FIX_CORS_ERROR_GUIDE.md" />
              <option name="updatedContent" value="#  HƯỚNG DẪN SỬA LỖI CORS - &quot;Multiple values not allowed&quot;&#10;&#10;## ❌ VẤN ĐỀ&#10;Postman hoạt động bình thường nhưng browser báo lỗi CORS:&#10;```&#10;Access-Control-Allow-Origin header contains multiple values 'http://localhost:3000, *', but only one is allowed&#10;```&#10;&#10;##  NGUYÊN NHÂN&#10;- **User Service** có `@CrossOrigin(origins = &quot;*&quot;)` → gửi header: `Access-Control-Allow-Origin: *`&#10;- **API Gateway** cũng có CORS config → gửi header: `Access-Control-Allow-Origin: http://localhost:3000`&#10;- Browser nhận được **2 headers trùng lặp** → BỊ CHẶN!&#10;- Postman không kiểm tra CORS → hoạt động bình thường&#10;&#10;## ✅ GIẢI PHÁP ĐÃ THỰC HIỆN&#10;&#10;### 1. Xóa `@CrossOrigin` khỏi UserController&#10;File: `user-service/src/main/java/vn/cnpm/user_service/Controller/UserController.java`&#10;- ✅ Đã xóa annotation `@CrossOrigin(origins = &quot;*&quot;)` &#10;- Lý do: API Gateway sẽ xử lý CORS thay vì backend&#10;&#10;### 2. Cấu hình API Gateway với DedupeResponseHeader&#10;File: `api-gateway/src/main/resources/application.yml`&#10;- ✅ Đã thêm filter `DedupeResponseHeader` vào tất cả routes&#10;- Filter này sẽ loại bỏ CORS headers trùng lặp nếu vẫn còn&#10;&#10;##  CÁC BƯỚC KHẮC PHỤC NGAY&#10;&#10;### Bước 1: Restart User Service&#10;User Service cần restart để áp dụng thay đổi (đã xóa @CrossOrigin):&#10;&#10;```cmd&#10;# Vào terminal đang chạy User Service, nhấn Ctrl+C để dừng&#10;# Sau đó chạy lại:&#10;cd C:\Study\CNPM\Food-fast-delivery\user-service&#10;mvnw spring-boot:run&#10;```&#10;&#10;Đợi đến khi thấy log: `Tomcat started on port(s): 8081`&#10;&#10;### Bước 2: Kiểm tra API Gateway đã chạy chưa&#10;```cmd&#10;# Nếu chưa chạy, khởi động:&#10;cd C:\Study\CNPM\Food-fast-delivery\api-gateway&#10;gradlew bootRun&#10;```&#10;&#10;Đợi đến khi thấy: `Netty started on port 8080`&#10;&#10;### Bước 3: Kiểm tra Eureka Dashboard&#10;Mở browser và vào: http://localhost:8761&#10;&#10;Đảm bảo thấy:&#10;- ✅ **API-GATEWAY** - Status: UP&#10;- ✅ **USER-SERVICE** - Status: UP&#10;&#10;Nếu không thấy → services chưa đăng ký được với Eureka.&#10;&#10;### Bước 4: Test API qua Gateway bằng Postman&#10;&#10;```bash&#10;# Test 1: Get all users (cần token)&#10;GET http://localhost:8080/api/users&#10;Headers:&#10;  Authorization: Bearer YOUR_TOKEN_HERE&#10;```&#10;&#10;Kiểm tra Response Headers trong Postman:&#10;- ✅ Chỉ có **1 header** `Access-Control-Allow-Origin: http://localhost:3000`&#10;- ❌ Không được có 2 headers trùng lặp&#10;&#10;### Bước 5: Clear Browser Cache và Restart Frontend&#10;&#10;```cmd&#10;# 1. Dừng frontend (Ctrl+C)&#10;# 2. Clear cache&#10;# 3. Restart:&#10;cd C:\Study\CNPM\Food-fast-delivery\Front_end\foodfast-app&#10;npm start&#10;```&#10;&#10;Trong browser:&#10;1. Nhấn `Ctrl+Shift+Delete`&#10;2. Chọn: &quot;Cached images and files&quot; + &quot;Cookies and other site data&quot;&#10;3. Click &quot;Clear data&quot;&#10;4. Đóng browser và mở lại&#10;&#10;### Bước 6: Test trong Admin Dashboard&#10;&#10;1. Vào: http://localhost:3000/login&#10;2. Login với admin&#10;3. Vào Admin Dashboard → Click tab &quot;User&quot;&#10;4. Mở DevTools (F12) → Tab Network&#10;5. Xem request tới `/api/users`:&#10;   - ✅ Status: 200 OK&#10;   - ✅ Không có lỗi CORS trong Console&#10;&#10;##  KẾT QUẢ MONG ĐỢI&#10;&#10;### TRƯỚC (Lỗi):&#10;```&#10;Response Headers:&#10;Access-Control-Allow-Origin: *&#10;Access-Control-Allow-Origin: http://localhost:3000&#10;❌ Browser: Error! Multiple values not allowed!&#10;```&#10;&#10;### SAU (Đúng):&#10;```&#10;Response Headers:&#10;Access-Control-Allow-Origin: http://localhost:3000&#10;Access-Control-Allow-Credentials: true&#10;✅ Browser: Request successful!&#10;```&#10;&#10;##  TROUBLESHOOTING&#10;&#10;### Vẫn còn lỗi CORS?&#10;&#10;**1. Kiểm tra User Service đã restart chưa:**&#10;```bash&#10;# Check log của User Service, phải thấy:&#10;Started UserServiceApplication in X seconds&#10;```&#10;&#10;**2. Kiểm tra Response Headers bằng Postman:**&#10;```bash&#10;GET http://localhost:8080/api/users&#10;# Xem Response Headers → Chỉ có 1 Access-Control-Allow-Origin&#10;```&#10;&#10;**3. Kiểm tra browser đã clear cache chưa:**&#10;- Browser có thể cache CORS preflight requests&#10;- Phải clear cache hoặc dùng Incognito mode&#10;&#10;**4. Kiểm tra có đang gọi đúng URL không:**&#10;- ✅ Đúng: `http://localhost:8080/api/users` (qua Gateway)&#10;- ❌ Sai: `http://localhost:8081/api/users` (trực tiếp User Service)&#10;&#10;### Lỗi &quot;Failed to fetch&quot; hoặc &quot;Network Error&quot;?&#10;&#10;**1. API Gateway chưa chạy:**&#10;```bash&#10;curl http://localhost:8080/actuator/health&#10;# Phải trả về: {&quot;status&quot;:&quot;UP&quot;}&#10;```&#10;&#10;**2. Services chưa đăng ký với Eureka:**&#10;- Vào http://localhost:8761&#10;- Kiểm tra danh sách services&#10;- Nếu không thấy → restart services theo thứ tự: Eureka → Gateway → User Service&#10;&#10;**3. Port bị chiếm:**&#10;```bash&#10;# Windows - Check port&#10;netstat -ano | findstr :8080&#10;netstat -ano | findstr :8081&#10;&#10;# Nếu có process khác đang dùng → kill process hoặc đổi port&#10;```&#10;&#10;##  LƯU Ý QUAN TRỌNG&#10;&#10;### Khi dùng API Gateway:&#10;1. ✅ **CHỈ Gateway** xử lý CORS&#10;2. ❌ **Backend services** KHÔNG được có `@CrossOrigin`&#10;3. ✅ Frontend gọi qua Gateway (port 8080)&#10;4. ✅ Postman test qua Gateway để đảm bảo đúng&#10;&#10;### Thứ tự khởi động services:&#10;```&#10;1. Eureka Service (8761)  ← Service Discovery&#10;2. API Gateway (8080)      ← Đợi 15-20s sau Eureka&#10;3. User Service (8081)     ← Đợi 10s sau Gateway&#10;```&#10;&#10;### Kiểm tra health:&#10;```bash&#10;# Eureka&#10;curl http://localhost:8761&#10;&#10;# API Gateway&#10;curl http://localhost:8080/actuator/health&#10;&#10;# User Service (qua Gateway)&#10;curl http://localhost:8080/api/users&#10;```&#10;&#10;## ✅ CHECKLIST SAU KHI SỬA&#10;&#10;- [ ] User Service đã restart (không còn @CrossOrigin)&#10;- [ ] API Gateway đang chạy với config mới&#10;- [ ] Cả 2 services đã đăng ký với Eureka&#10;- [ ] Postman test qua Gateway thành công (chỉ 1 CORS header)&#10;- [ ] Browser cache đã được clear&#10;- [ ] Frontend đã restart&#10;- [ ] DevTools Console không còn lỗi CORS&#10;- [ ] Admin Dashboard hiển thị danh sách users&#10;&#10;##  HOÀN THÀNH!&#10;&#10;Sau khi làm theo các bước trên, lỗi CORS sẽ biến mất và bạn có thể:&#10;- ✅ Xem danh sách users trong Admin Dashboard&#10;- ✅ Search users&#10;- ✅ Toggle user status&#10;- ✅ Delete users&#10;- ✅ Tất cả API calls đều hoạt động bình thường&#10;&#10;---&#10;**Tạo bởi:** GitHub Copilot&#10;**Ngày:** 2025-11-09&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/test-api.html">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/test-api.html" />
              <option name="updatedContent" value="&lt;!DOCTYPE html&gt;&#10;&lt;html&gt;&#10;&lt;head&gt;&#10;    &lt;title&gt;Test Product API&lt;/title&gt;&#10;&lt;/head&gt;&#10;&lt;body&gt;&#10;    &lt;h1&gt;Test Product API&lt;/h1&gt;&#10;    &lt;button onclick=&quot;testProducts()&quot;&gt;Test Get All Products&lt;/button&gt;&#10;    &lt;button onclick=&quot;testCategories()&quot;&gt;Test Get All Categories&lt;/button&gt;&#10;    &lt;button onclick=&quot;testRestaurants()&quot;&gt;Test Get All Restaurants&lt;/button&gt;&#10;    &lt;div id=&quot;result&quot;&gt;&lt;/div&gt;&#10;&#10;    &lt;script&gt;&#10;        async function testProducts() {&#10;            const resultDiv = document.getElementById('result');&#10;            resultDiv.innerHTML = '&lt;p&gt;Loading products...&lt;/p&gt;';&#10;            &#10;            try {&#10;                const response = await fetch('http://localhost:8080/api/products');&#10;                const data = await response.json();&#10;                resultDiv.innerHTML = '&lt;h2&gt;Products Response:&lt;/h2&gt;&lt;pre&gt;' + JSON.stringify(data, null, 2) + '&lt;/pre&gt;';&#10;                console.log('Products:', data);&#10;            } catch (error) {&#10;                resultDiv.innerHTML = '&lt;h2 style=&quot;color: red;&quot;&gt;Error:&lt;/h2&gt;&lt;p&gt;' + error.message + '&lt;/p&gt;';&#10;                console.error('Error:', error);&#10;            }&#10;        }&#10;&#10;        async function testCategories() {&#10;            const resultDiv = document.getElementById('result');&#10;            resultDiv.innerHTML = '&lt;p&gt;Loading categories...&lt;/p&gt;';&#10;            &#10;            try {&#10;                const response = await fetch('http://localhost:8080/api/categories');&#10;                const data = await response.json();&#10;                resultDiv.innerHTML = '&lt;h2&gt;Categories Response:&lt;/h2&gt;&lt;pre&gt;' + JSON.stringify(data, null, 2) + '&lt;/pre&gt;';&#10;                console.log('Categories:', data);&#10;            } catch (error) {&#10;                resultDiv.innerHTML = '&lt;h2 style=&quot;color: red;&quot;&gt;Error:&lt;/h2&gt;&lt;p&gt;' + error.message + '&lt;/p&gt;';&#10;                console.error('Error:', error);&#10;            }&#10;        }&#10;&#10;        async function testRestaurants() {&#10;            const resultDiv = document.getElementById('result');&#10;            resultDiv.innerHTML = '&lt;p&gt;Loading restaurants...&lt;/p&gt;';&#10;            &#10;            try {&#10;                const response = await fetch('http://localhost:8080/api/restaurants');&#10;                const data = await response.json();&#10;                resultDiv.innerHTML = '&lt;h2&gt;Restaurants Response:&lt;/h2&gt;&lt;pre&gt;' + JSON.stringify(data, null, 2) + '&lt;/pre&gt;';&#10;                console.log('Restaurants:', data);&#10;            } catch (error) {&#10;                resultDiv.innerHTML = '&lt;h2 style=&quot;color: red;&quot;&gt;Error:&lt;/h2&gt;&lt;p&gt;' + error.message + '&lt;/p&gt;';&#10;                console.error('Error:', error);&#10;            }&#10;        }&#10;    &lt;/script&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>